<script>
(function() {
  // Mobile device detection
  function isMobileDevice() {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    const mobileRegex = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
    const isMobileUA = mobileRegex.test(userAgent);
    const isMobileScreen = window.innerWidth <= 768 && window.innerHeight <= 1024;
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    return isMobileUA || (isMobileScreen && isTouchDevice);
  }

  // Auto-redirect mobile browsers to deep link
  function handleMobileAutoRedirect() {
    if (!isMobileDevice()) {
      console.log('üñ•Ô∏è Desktop browser detected - showing manual options');
      return;
    }

    console.log('üì± Mobile browser detected - attempting auto-redirect to deep link');

    // Extract auth parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const authParams = {
      access_token: urlParams.get('access_token'),
      refresh_token: urlParams.get('refresh_token'),
      expires_at: urlParams.get('expires_at') || urlParams.get('expires_in'),
      token_type: urlParams.get('token_type') || 'bearer',
      auth_method: urlParams.get('auth_method') || 'email',
      flow_type: urlParams.get('flow_type') || 'pkce',
      verified: 'true'
    };

    // Only auto-redirect if we have valid auth tokens
    if (authParams.access_token && authParams.refresh_token) {
      const deepLinkParams = new URLSearchParams();
      Object.entries(authParams).forEach(([key, value]) => {
        if (value) deepLinkParams.set(key, value);
      });

      const deepLink = `manito://auth/verified?${deepLinkParams.toString()}`;

      console.log('üöÄ AUTO-REDIRECTING to mobile app:', deepLink);

      // Show auto-redirect message
      const autoRedirectDiv = document.createElement('div');
      autoRedirectDiv.innerHTML = `
        <div style="text-align: center; padding: 20px; background: #f0f9ff; border-radius: 8px; margin: 20px;">
          <h3 style="color: #0369a1; margin-bottom: 10px;">üì± Redirecting to Manito App...</h3>
          <p style="color: #075985; margin-bottom: 15px;">Detected mobile device - opening Manito app automatically</p>
          <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #0ea5e9; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          <p style="color: #0c4a6e; font-size: 14px; margin-top: 15px;">If the app doesn't open, use the buttons below</p>
        </div>
        <style>
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      `;

      // Insert auto-redirect message at the top
      const container = document.querySelector('.container') || document.body;
      container.insertBefore(autoRedirectDiv, container.firstChild);

      // Attempt deep link redirect
      window.location.href = deepLink;

      // Fallback: Show manual options after 3 seconds if deep link fails
      setTimeout(() => {
        console.log('‚ö†Ô∏è Deep link may have failed - showing manual options');
        autoRedirectDiv.style.display = 'none';
      }, 3000);

    } else {
      console.log('‚ö†Ô∏è Missing auth tokens - showing manual options');
    }
  }

  // Run auto-redirect when page loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', handleMobileAutoRedirect);
  } else {
    handleMobileAutoRedirect();
  }
})();
</script>
