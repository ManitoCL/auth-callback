<!DOCTYPE html>
  <html lang="es">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Email Verificado - Manito</title>
      <style>
          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }

          body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              min-height: 100vh;
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 20px;
          }

          .container {
              background: white;
              padding: 40px;
              border-radius: 16px;
              box-shadow: 0 20px 40px rgba(0,0,0,0.1);
              text-align: center;
              max-width: 500px;
              width: 100%;
          }

          .icon {
              font-size: 60px;
              margin-bottom: 20px;
          }

          .success { color: #10B981; }
          .error { color: #EF4444; }

          h1 {
              color: #1F2937;
              margin-bottom: 16px;
              font-size: 28px;
              font-weight: 700;
          }

          p {
              color: #6B7280;
              line-height: 1.6;
              margin-bottom: 24px;
              font-size: 16px;
          }

          .mobile-redirect {
              background: #EEF2FF;
              border: 2px solid #667eea;
              padding: 24px;
              border-radius: 12px;
              margin: 24px 0;
          }

          .mobile-redirect h3 {
              color: #374151;
              margin-bottom: 12px;
              font-size: 18px;
          }

          .mobile-redirect p {
              color: #4B5563;
              margin-bottom: 16px;
              font-size: 14px;
          }

          .spinner {
              display: inline-block;
              width: 20px;
              height: 20px;
              border: 3px solid #667eea;
              border-top: 3px solid transparent;
              border-radius: 50%;
              animation: spin 1s linear infinite;
          }

          @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
          }

          .desktop-instructions {
              background: #F0FDF4;
              border-left: 4px solid #10B981;
              padding: 20px;
              border-radius: 0 8px 8px 0;
              margin: 24px 0;
          }

          .desktop-instructions h3 {
              color: #10B981;
              margin-bottom: 12px;
              font-size: 18px;
          }

          .close-btn {
              background: #667eea;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 8px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
              transition: background 0.2s;
          }

          .close-btn:hover {
              background: #5b6ad6;
          }
      </style>
  </head>
  <body>
      <div class="container">
          <div id="success-state">
              <div class="icon success">‚úÖ</div>
              <h1>¬°Email Verificado!</h1>
              <p>Tu cuenta ha sido confirmada exitosamente.</p>

              <!-- Mobile redirect notification -->
              <div id="mobile-redirect" class="mobile-redirect" style="display: none;">
                  <h3>üì± Abriendo Manito...</h3>
                  <p>Detectamos que est√°s en un dispositivo m√≥vil. Te estamos redirigiendo a la app autom√°ticamente.</p>
                  <div class="spinner"></div>
                  <p style="font-size: 12px; margin-top: 16px;">Si la app no se abre, b√∫scala en tu dispositivo</p>
              </div>

              <!-- Desktop instructions -->
              <div id="desktop-instructions" class="desktop-instructions" style="display: none;">
                  <h3>üì± Abre Manito en tu dispositivo m√≥vil</h3>
                  <p>Tu email ha sido verificado. Abre la aplicaci√≥n Manito en tu dispositivo m√≥vil para continuar. La sesi√≥n
  se sincronizar√° autom√°ticamente.</p>
              </div>

              <button class="close-btn" onclick="closeWindow()">Entendido</button>
          </div>

          <div id="error-state" style="display: none;">
              <div class="icon error">‚ùå</div>
              <h1>Error en la Verificaci√≥n</h1>
              <p id="error-message">Hubo un problema al verificar tu email. Por favor intenta nuevamente.</p>
              <button class="close-btn" onclick="closeWindow()">Cerrar</button>
          </div>
      </div>

      <script>
          // Phase 1: Simplified verification handler
          (function() {
              console.log('üöÄ Phase 1 Email Verification - Web Frontend');

              // Platform detection
              function isMobileDevice() {
                  const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                  const mobileRegex = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
                  const isMobileUA = mobileRegex.test(userAgent);
                  const isMobileScreen = window.innerWidth <= 768 && window.innerHeight <= 1024;
                  const isTouchDevice = "ontouchstart" in window || navigator.maxTouchPoints > 0;
                  return isMobileUA || (isMobileScreen && isTouchDevice);
              }

              // Extract tokens from URL params (Phase 1 approach)
              function extractTokens() {
                  const urlParams = new URLSearchParams(window.location.search);
                  return {
                      access_token: urlParams.get('access_token'),
                      refresh_token: urlParams.get('refresh_token'),
                      expires_at: urlParams.get('expires_at'),
                      token_type: urlParams.get('token_type') || 'bearer',
                      verified: urlParams.get('verified') || 'true',
                      flow: urlParams.get('flow') || 'phase1_simplified'
                  };
              }

              // Mobile redirect to app with tokens
              function redirectToMobileApp(tokens) {
                  if (!tokens.access_token || !tokens.refresh_token) {
                      console.error('‚ùå Missing tokens for mobile redirect');
                      showError('Tokens de verificaci√≥n inv√°lidos');
                      return;
                  }

                  const deepLinkParams = new URLSearchParams();
                  Object.entries(tokens).forEach(([key, value]) => {
                      if (value) deepLinkParams.set(key, value);
                  });

                  const deepLink = `manito://auth/verified?${deepLinkParams.toString()}`;
                  console.log('üì± Phase 1 Mobile Deep Link:', {
                      hasTokens: !!(tokens.access_token && tokens.refresh_token),
                      deepLinkLength: deepLink.length
                  });

                  // Show mobile redirect UI
                  document.getElementById('mobile-redirect').style.display = 'block';

                  // Attempt redirect
                  window.location.href = deepLink;

                  // Fallback for iOS
                  setTimeout(() => {
                      const link = document.createElement('a');
                      link.href = deepLink;
                      link.click();
                  }, 500);

                  // Hide spinner after attempt
                  setTimeout(() => {
                      const spinner = document.querySelector('.spinner');
                      if (spinner) {
                          spinner.style.display = 'none';
                      }
                  }, 3000);
              }

              // Show desktop instructions
              function showDesktopInstructions() {
                  document.getElementById('desktop-instructions').style.display = 'block';
              }

              // Show error state
              function showError(message) {
                  document.getElementById('success-state').style.display = 'none';
                  document.getElementById('error-state').style.display = 'block';
                  document.getElementById('error-message').textContent = message;
              }

              // Main verification handler
              function handleVerification() {
                  try {
                      const tokens = extractTokens();

                      // Check for error parameter
                      const urlParams = new URLSearchParams(window.location.search);
                      const error = urlParams.get('error');
                      if (error) {
                          showError('Error en la verificaci√≥n: ' + error);
                          return;
                      }

                      // Validate required tokens
                      if (!tokens.access_token || !tokens.refresh_token) {
                          showError('Esta p√°gina solo es accesible desde enlaces de verificaci√≥n de email v√°lidos.');
                          return;
                      }

                      console.log('‚úÖ Phase 1 Tokens received:', {
                          hasAccessToken: !!tokens.access_token,
                          hasRefreshToken: !!tokens.refresh_token,
                          flow: tokens.flow,
                          verified: tokens.verified
                      });

                      // Platform-specific handling
                      if (isMobileDevice()) {
                          console.log('üì± Mobile device detected - redirecting to app');
                          redirectToMobileApp(tokens);
                      } else {
                          console.log('üñ•Ô∏è Desktop device detected - showing instructions');
                          showDesktopInstructions();
                      }

                  } catch (error) {
                      console.error('‚ùå Phase 1 Verification Error:', error);
                      showError('Error inesperado al procesar la verificaci√≥n');
                  }
              }

              // Close window function
              window.closeWindow = function() {
                  try {
                      window.close();
                  } catch (e) {
                      // Fallback: redirect to main site
                      window.location.href = 'https://manito.cl';
                  }
              };

              // Initialize when DOM is ready
              if (document.readyState === 'loading') {
                  document.addEventListener('DOMContentLoaded', handleVerification);
              } else {
                  handleVerification();
              }

          })();
      </script>
  </body>
  </html>
